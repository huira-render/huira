name: Windows CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  actions: read
  checks: write
  pull-requests: write

jobs:
  version-check:
    name: Version Check
    uses: ./.github/workflows/version-check.yml

  build-windows:
    needs: version-check
    runs-on: windows-2022
    name: Build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up build environment
        uses: ./.github/actions/setup
        with:
          platform: windows

      - name: Configure project
        uses: ./.github/actions/cmake-configure
        with:
          platform: windows

      - name: Build project
        uses: ./.github/actions/build
        with:
          platform: windows

  test:
    needs: build-windows
    runs-on: windows-2022
    name: Test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up build environment
        uses: ./.github/actions/setup
        with:
          platform: windows

      - name: Configure project for testing
        uses: ./.github/actions/cmake-configure-test
        with:
          platform: windows

      - name: Build project
        uses: ./.github/actions/build
        with:
          platform: windows

      - name: Run tests
        shell: bash -el {0}
        run: |
          echo "Running tests..."
          cd build
          ctest -C Release --output-on-failure
          echo "Tests completed!"

      - name: Check for test results
        if: always()
        shell: bash -el {0}
        run: |
          echo "Checking for test result files..."
          ls -la build/test-results/ || echo "test-results directory not found"

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-windows
          path: build/test-results/*.xml
          retention-days: 30

      - name: Publish test results
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: Windows Test Results
          path: build/test-results/*.xml
          reporter: java-junit
          fail-on-error: false

  # Gate job that depends on all other jobs - use this for branch protection
  windows-ci:
    name: Windows CI
    if: always()
    needs:
      - version-check
      - build-windows
      - test
    runs-on: ubuntu-22.04
    steps:
      - name: Check all jobs passed
        run: |
          if [[ "${{ contains(needs.*.result, 'failure') }}" == "true" || "${{ contains(needs.*.result, 'cancelled') }}" == "true" ]]; then
            echo "One or more jobs failed or were cancelled"
            exit 1
          fi
          echo "All jobs passed successfully"
